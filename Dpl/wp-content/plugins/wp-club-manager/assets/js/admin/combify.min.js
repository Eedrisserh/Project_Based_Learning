(function(a){a.widget("ui.combify",{options:{maxLength:0},_create:function(){function b(b,c,d){var e=b.parent().parent().next();if(e.is(":visible")||a(i).autocomplete("widget").is(":visible"))e.hide();else{var f=30>=n.length?n.length:30;var g=1===f?2:f;e.css({width:"auto",position:"absolute","z-index":"1"}).prop("size",g).show(),d>e.width()&&e.css("width",d);var h=parseInt(e.find("option").first().css("font-size"),10);e.css("height",h*(f+1)),a(document).one("click",function(){e.hide()}),a(document).off("keydown.combifySelect").on("keydown.combifySelect",function(a){function b(b){a.preventDefault();var c=e.find(":selected");if(b==="down")var d=c.next();if("up"===b)var d=c.prev();c.prop("selected",!1),d.prop("selected","selected")}return 38===a.which&&e.is(":visible")?void b("up"):40===a.which&&e.is(":visible")?void b("down"):13===a.which&&e.is(":visible")?(e.trigger("change"),void e.hide()):void(e.is(":visible")&&e.hide())})}}var c=this,d=c.element,e=c.options,f=d.prop("id"),g="#"+f,h="CombifyInput-"+f,i="#"+h,j=d.prop("name"),k=d.find(":selected").val(),l=d.find(":selected").text(),m=d.find("option"),n=[];d.hide(),d.before("<div><span class=\"ui-combobox\"><input type=\"hidden\" class=\"insertedInput\" id=\""+f+"\" name=\""+j+"\" value=\""+k+"\"><input type=\"text\" id=\""+h+"\" class=\"ui-combobox-input\" value=\""+l+"\"></span></div>"),d.removeAttr("id",null).removeAttr("name",null).on("change",function(a){a.stopPropagation()}),m.each(function(){n.push(a(this).text())}),a(i).autocomplete({source:n,select:function(b,c){this.value=c.item.value;var e=a(d).find("option").filter(function(){return a(this).html()==c.item.value}).first(),f=e.val();a(g).val(f),a(this).trigger("change")}}).on("change",function(){var b=a(this).val(),c=a(d).find("option").filter(function(){return a(this).html()==b}).first();c.length?a(g).val(c.val()):a(g).val(b)}).on("blur",function(){a(this).trigger("change")}),0<e.maxLength&&a(i).keyup(function(){if(a(this).val().length>e.maxLength){var b=a(this).val();a(this).data("val",b.substring(0,e.maxLength)),a(this).val(b.substring(0,e.maxLength))}}),d.on("change",function(){var b=a(this).prev().find("#"+f).first(),c=a(this).val(),e=a(this).find("option:selected").text(),g=a(d).find("option").filter(function(){return a(this).html()==e}).first();b.val(c),a(i).val(g.text()),b.trigger("change")}),a(i).keydown(function(c){var d=a(this).parent().parent().next();40===c.which&&c.altKey&&(c.preventDefault(),c.stopPropagation(),d.is(":visible")?d.hide():(e.capitalizeInput&&(this.value=this.value.toUpperCase()),a(i).autocomplete("close"),b(a(this),c,a(this).width())))});var o=d.prev().first().find(".ui-combobox-list");o.change(function(){a(this).hide()})},_destroy:function(){var a=this.element,b=a.prev().find(".insertedInput"),c="",d="";c=b.prop("id"),d=b.prop("name"),a.attr({id:c,name:d}),a.off("change"),a.prev().remove(),a.show()}})})(jQuery);